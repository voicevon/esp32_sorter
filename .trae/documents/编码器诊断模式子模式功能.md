# 编码器诊断模式子模式功能实现计划

## 需求分析

为MODE\_DIAGNOSE\_ENCODER模式添加子模式功能，解决OLED显示与中断优先级冲突的问题。

## 实现方案

### 1. 添加编码器子模式变量

* 在main.cpp中添加`encoderSubMode`全局变量

* 0: 显示编码器位置

* 1: 显示编码器相位变化（或其他信息）

### 2. 修改Encoder类

* 添加`getLatestPosition()`方法，获取最新位置

* 添加`hasPositionChanged()`方法，检查位置是否变化

* 添加`resetPositionChangedFlag()`方法，重置变化标志

* 修改中断处理函数，设置位置变化标志，而不是直接调用OLED

### 3. 修改MODE\_DIAGNOSE\_ENCODER的处理逻辑

* 添加子模式初始化和切换逻辑

* 子模式0：显示当前编码器位置（只在位置变化时更新）

* 子模式1：显示相位变化信息（只在相位变化时更新）

### 4. 修改OLED显示

* 在update方法中添加对MODE\_DIAGNOSE\_ENCODER的支持

* 根据encoderSubMode显示不同内容

* 确保显示更新在主循环中进行，不在中断中

### 5. 添加从按钮切换功能

* 在MODE\_DIAGNOSE\_ENCODER模式下，从按钮切换子模式

* 显示子模式切换信息到OLED

### 6. 更新文档

* 在31 system\_mode\_management.md中更新MODE\_DIAGNOSE\_ENCODER的描述

* 添加子模式说明

## 关键设计原则

* **解耦中断和显示**：中断只设置标志，不直接调用OLED

* **避免过度刷新**：只在数值变化时更新显示

* **优先级管理**：显示在主循环中进行，不阻塞中断

