# DiverterController类实现要求文档

## 1. 概述

DiverterController类用于封装ESP32分拣系统中的分支器（舵机）控制功能，根据编码器提供的位置信息和物体直径分类结果，精确控制5个分支器（对应5个出口）的动作以实现物体的准确分流。

## 2. 分支器技术规格

- **数量**：5个分支器，每个分支器包含一个舵机，直接对应5个出口
- **安装位置**：分支器是固定安装的出口结构，不随传输带移动
- **控制方式**：PWM信号（50Hz频率）
- **角度对应关系**：
  - 0.5ms脉冲宽度：0°位置（关闭状态）
  - 1.5ms脉冲宽度：90°位置（中间位置）
  - 2.5ms脉冲宽度：180°位置（开启状态）

## 3. 类定义与成员

### 3.1 公共接口

- **初始化方法**
  - `void initialize(const int pins[])`：使用指定引脚初始化所有分支器舵机
  - `void reset()`：将所有分支器重置到默认位置（关闭状态）

- **分支器控制方法**
  - `void activateDiverter(int exitIndex)`：激活指定出口的分支器
  - `void deactivateDiverter(int exitIndex)`：停用指定出口的分支器

- **状态管理方法**
  - `void update(long encoderPosition)`：根据编码器位置更新分支器状态
  - `void resetAllDiverters()`：重置所有分支器到默认位置

- **调试信息方法**
  - `void printStatus()`：输出所有分支器的当前状态

### 3.2 常量定义

- `NUM_DIVERTERS`：分支器总数（5个）
- `SERVO_STANDARD_POSITION`：标准位置（90°，不分流）
- `SERVO_ASSIGN_POSITION_1`：分配位置1（0°，分流）
- `SERVO_ACTION_DELAY`：舵机动作时间（毫秒）
- `SERVO_RECOVERY_DELAY`：舵机恢复时间（毫秒）

### 3.3 私有成员变量

- **舵机控制**
  - `Servo diverters[NUM_DIVERTERS]`：舵机对象数组，直接对应5个分支器
  - `int servoPins[NUM_DIVERTERS]`：存储每个分支器舵机的引脚号
  - `bool activeDiverters[NUM_DIVERTERS]`：跟踪每个分支器的激活状态
  - `unsigned long actionTimers[NUM_DIVERTERS]`：动作定时器
  - `bool initialized`：初始化标志

## 4. 分支器工作流程

- **预激活阶段**：当编码器位置接近目标位置前的准备点时，预先准备相应出口的分支器
- **激活阶段**：当编码器位置到达第85相位时，根据物体直径激活对应的分支器
- **保持阶段**：保持分支器开启状态一段时间，确保物体完全通过
- **重置阶段**：在物体通过后，将分支器重置到默认位置

### 分支器动作时序

分支器的动作时序由编码器回调机制精确控制，具体如下：

1. **触发条件**：由编码器提供的位置信息（相位85）触发回调
2. **判断逻辑**：系统检查当前出口位置索引是否与某个直径数据索引匹配
3. **动作执行**：如果匹配且直径满足条件，则触发对应分支器动作
4. **持续时间**：分支器动作持续到下一个编码器位置触发点
5. **自动恢复**：当传输线编码器位置达到特定相位时，通过回调函数将分支器自动复位到标准位置

## 5. 与编码器的协作

- 接收Encoder类提供的位置信息（通过update方法）
- 根据位置信息判断何时激活或重置分支器
> **重要说明**：相位范围是0-199，代表物理上一圈的位置。所有出口分支器在第85相位位置触发动作。关于编码器与传送带、出口的具体对应关系，请参考[传送带系统文档](convenyor.md)。
- 使用编码器的零位信号（Z相）同步系统状态

### 编码器与分支器的关系

编码器不直接驱动分支器，而是提供触发条件和位置信息：

1. **提供位置信息**：编码器提供传送带的精确位置信息
2. **触发回调**：当相位达到85时，编码器触发位置回调函数，这是系统中最关键的同步点
3. **出口判断**：系统利用编码器位置信息，在相位85时判断所有出口的分配条件
4. **间接控制**：编码器不直接控制分支器，而是提供精确的位置触发点，实际的分支器控制由DiverterController执行

#### 相位85回调机制详解
当编码器相位达到85时的回调过程如下：
1. 编码器触发位置回调函数
2. 回调函数调用DiverterController的检查方法
3. DiverterController遍历所有出口（1-5号）
4. 对于每个出口，查找对应的直径数据索引
5. 检查直径数据是否满足出口的直径范围要求
6. 如果满足条件，立即触发分支器动作，使芦笋从传输线上分离到输出仓
7. 当传输线编码器位置达到特定相位时，通过回调函数将分支器自动复位到标准位置

这种机制确保了所有出口的动作都在精确的物理位置上执行，实现了芦笋的准确分拣。

## 6. 异常处理

- 检测舵机连接状态
- 处理无效的出口索引请求
- 防止多个分支器同时激活的冲突情况
- 基于编码器位置触发的分支器复位机制，确保分支器在精确位置完成动作