# ESP32 Sorter 硬件参考手册

本文档提供了ESP32分拣系统硬件组件的参考说明。

---

## 1. 系统硬件概述

### 1.1 硬件组件

- **主编码器模块 (Encoder)**：增量式编码器，用于位置检测。
- **RS485接口**：用于与外部系统进行通信。
- **点扫描仪 (Point Scanner)**：5点扫描仪阵列，用于物体检测。
- **舵机 (Servo)**：3个控制舵机，不控制出口，专门用于**上料器 (Feeder) / 上送料器**。
- **电磁铁 (Solenoid)**：8个 12V 供电的电磁铁，用于控制出口分流，通过 HC595 移位寄存器控制。
- **HC595 移位寄存器**：3个 74HC595 级联，用于扩展输出。其中 Index 0（离MCU最近）的一组用于驱动8个状态指示 LED，其余用于驱动 12V 电磁铁。
- **电源电压监测**：用于监测系统工作电压。
- **HMI模块**：1个带按钮的旋转编码器，用于人机交互。包含A相、B相和按键。
- **显示器 (Display)**：I2C OLED显示器。

### 1.2 引脚连接表

| 硬件组件 | ESP32引脚 | 功能说明 |
|----------|-----------|----------|
| 编码器A相 | GPIO 19 | A相输入信号 |
| 编码器B相 | GPIO 21 | B相输入信号 |
| 编码器Z相(Zero) | GPIO 18 | 零位信号输入 |
| RS485 TX | GPIO 17 | 数据发送信号 |
| RS485 RX | GPIO 16 | 数据接收信号 |
| RS485 发送使能 | GPIO 5 | 发送使能信号 (TX Enable) |
| 扫描仪点1 | GPIO 36 (VP) | 信号输入 |
| 扫描仪点2 | GPIO 39 (VN) | 信号输入 |
| 扫描仪点3 | GPIO 34 | 信号输入 |
| 扫描仪点4 | GPIO 35 | 信号输入 |
| 扫描仪点5 | GPIO 15 | 信号输入 |
| 上料器舵机1 | GPIO 27 | PWM控制信号 |
| 上料器舵机2 | GPIO 26 | PWM控制信号 |
| 上料器舵机3 | GPIO 25 | PWM控制信号 |
| HC595 数据 (DS) | GPIO 33 | SPI 数据输入 |
| HC595 时钟 (SHCP) | GPIO 4 | 移位寄存器时钟 |
| HC595 锁存 (STCP) | GPIO 2 | 存储寄存器时钟/锁存 |
| 电源电压监测 | GPIO 32 | ADC模拟输入探测电压 |
| OLED SDA | GPIO 23 | I2C数据信号 |
| OLED SCL | GPIO 22 | I2C时钟信号 |
| HMI编码器A相 | GPIO 13 | 旋转编码器A相 |
| HMI编码器B相 | GPIO 12 | 旋转编码器B相 |
| HMI编码器按键 | GPIO 14 | 旋转编码器按下 (Push/Press) |
| 串口TX0 | GPIO 1 | 调试/下载 |
| 串口RX0 | GPIO 3 | 调试/下载 |

### 1.3 引脚使用统计

| 设备类型 | 数量 | 使用引脚数 |
|----------|------|------------|
| 编码器 | 1 | 3 |
| RS485接口 | 1 | 3 |
| 扫描仪 | 1 | 5 |
| 上料器舵机 | 3 | 3 |
| HC595寄存器 | 3 | 3 |
| 电压监测 | 1 | 1 |
| OLED显示器 | 1 | 2 |
| HMI模块 | 1 | 3 |
| 串口 | 1 | 2 |
| **已分配引脚总计** | | **25个引脚** |

---

## 2. 编码器 (Encoder)

### 2.1 概述
Encoder类采用单例模式提供位置跟踪和中断处理。它追踪0-199的相位范围，用于精确的位置控制。

### 2.2 核心逻辑
- **中断**：使用AB相双中断模式和四状态解码算法，以实现高精度和抗干扰能力。
- **零位重置**：Z相中断在零位特定位置重置计数器。
- **相位回调**：当编码器相位发生变化时触发回调。

---

## 3. 直径扫描仪 (Diameter Scanner)

### 3.1 概述
DiameterScanner类处理数据采样并使用5点扫描仪阵列计算直径。

### 3.2 工作原理
1.  **采样**：同时采样5个点以测量物体直径。
2.  **加权**：对每个点应用权重系数以补偿芦笋的特定形状（锥度）：
    -   待更新...
3.  **过滤**：丢弃无效数据（小于3mm / 6个单位）。
4.  **计算**：根据有效数据数量使用基于中位数的算法。
5.  **输出**：返回以"unit"为单位的直径。实际毫米数 = unit值 / 2。

### 3.3 诊断模式
- **模式1 (IO检查)**：显示5个传感器的原始高/低电平状态。
- **模式2 (边缘校准)**：记录上升沿/下降沿的编码器值。
- **模式3 (直径测试)**：显示计算出的原始直径值。

---

## 4. 系统出口 (System Outlets)

### 4.1 概述
控制各个出口电磁铁，根据直径范围将物品分流到特定通道。不再使用舵机控制出口。

### 4.2 控制逻辑
- **初始化**：通过 HC595 寄存器设置电磁铁的状态和直径范围（最小/最大mm）。工作电压为 12V。
- **执行 (Execute)**：根据预设状态驱动相应通道的电磁铁动作。

### 4.3 测试
- **轮巡测试**...

