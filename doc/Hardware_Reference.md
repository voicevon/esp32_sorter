# ESP32 Sorter 硬件参考手册

本文档提供了ESP32分拣系统硬件组件的参考说明。

---

## 1. 系统硬件概述

### 1.1 硬件组件

- **编码器模块 (Encoder)**：100线增量式编码器，用于位置检测。
- **直径扫描仪 (Diameter Scanner)**：4点激光扫描仪，用于物体直径检测。
- **出口 (Outlet)**：8个舵机，用于控制物体分流。
- **上料器 (Feeder)**：1个舵机，用于控制物料上料。
- **调试模块 (Debug Module)**：2个按钮和2个LED，用于模式切换和状态指示。
- **显示器 (Display)**：SSD1306 I2C OLED显示器，用于显示系统状态和参数。

### 1.2 引脚连接表

| 硬件组件 | ESP32引脚 | 功能说明 |
|----------|-----------|----------|
| 编码器A相 | GPIO 21 | A相输入信号 |
| 编码器B相 | GPIO 19 | B相输入信号 |
| 编码器Z相 | GPIO 18 | 零位信号输入 |
| 扫描仪点1 | GPIO 36 | 信号输入 |
| 扫描仪点2 | GPIO 35 | 信号输入 |
| 扫描仪点3 | GPIO 34 | 信号输入 |
| 扫描仪点4 | GPIO 39 | 信号输入 |
| OLED数据 (SDA) | GPIO 23 | I2C数据信号 |
| OLED时钟 (SCL) | GPIO 22 | I2C时钟信号 |
| 舵机1 | GPIO 13 | PWM控制信号 |
| 舵机2 | GPIO 12 | PWM控制信号 |
| 舵机3 | GPIO 14 | PWM控制信号 |
| 舵机4 | GPIO 27 | PWM控制信号 |
| 舵机5 | GPIO 26 | PWM控制信号 |
| 舵机6 | GPIO 25 | PWM控制信号 |
| 舵机7 | GPIO 33 | PWM控制信号 |
| 舵机8 | GPIO 32 | PWM控制信号 |
| 上料器舵机 | ~~GPIO 15~~ | ~~PWM控制信号~~ (已禁用) |
| 从按钮 | GPIO 5 | 输入（中断） |
| 主按钮 | GPIO 4 | 输入（中断） |
| 从LED | ~~GPIO 17~~ | ~~输出~~ (已禁用) |
| 主LED | ~~GPIO 16~~ | ~~输出~~ (已禁用) |
| 串口TX0 | GPIO 1 | 调试/下载 |
| 串口RX0 | GPIO 3 | 调试/下载 |

### 1.3 引脚使用统计

| 设备类型 | 数量 | 使用引脚数 |
|----------|------|------------|
| 编码器 | 1 | 3 |
| 扫描仪 | 1 | 4 |
| 出口舵机 | 8 | 8 |
| 上料器舵机 | 1 | 1 |
| 调试模块 | 2按钮 + 2LED | 4 |
| OLED显示器 | 1 | 2 |
| 串口 | 1 | 2 |
| **总计** | | **24个引脚** |

---

## 2. 编码器 (Encoder)

### 2.1 概述
Encoder类采用单例模式提供位置跟踪和中断处理。它追踪0-199的相位范围，用于精确的位置控制。

### 2.2 核心逻辑
- **中断**：使用AB相双中断模式和四状态解码算法，以实现高精度和抗干扰能力。
- **零位重置**：Z相中断在零位特定位置重置计数器。
- **相位回调**：当编码器相位发生变化时触发回调。

---

## 3. 直径扫描仪 (Diameter Scanner)

### 3.1 概述
DiameterScanner类处理数据采样并使用4点扫描仪阵列计算直径。

### 3.2 工作原理
1.  **采样**：同时采样4个点以测量物体直径。
2.  **加权**：对每个点应用权重系数以补偿芦笋的特定形状（锥度）：
    -   点1: 1.01
    -   点2: 1.02
    -   点3: 1.05
    -   点4: 1.15
3.  **过滤**：丢弃无效数据（小于3mm / 6个单位）。
4.  **计算**：根据有效数据数量使用基于中位数的算法：
    -   2个有效：平均值。
    -   3个有效：中位数。
    -   4个有效：去除最大最小值后取平均。
5.  **输出**：返回以"unit"为单位的直径。实际毫米数 = unit值 / 2。

### 3.3 诊断模式
- **模式1 (IO检查)**：显示4个传感器的原始高/低电平状态。
- **模式2 (边缘校准)**：记录上升沿/下降沿的编码器值。
- **模式3 (直径测试)**：显示计算出的原始直径值。

---

## 4. 系统出口 (System Outlets)

### 4.1 概述
控制各个出口舵机，根据直径范围将物品分流到特定通道。

### 4.2 控制逻辑
- **初始化**：设置舵机引脚和直径范围（最小/最大mm）。
- **预开 (Pre-Open)**：设置"准备打开/关闭"状态。
- **执行 (Execute)**：根据预设状态驱动舵机到达目标位置。

### 4.3 测试
- **轮巡降落测试**：依次打开/关闭每个出口（打开5秒，等待5秒）。
- **轮巡上升测试**：反向逻辑（当其他关闭时打开一个）。
- **OLED显示**：在测试期间可视化出口阵列状态。
