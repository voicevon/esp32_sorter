# 传送带系统软件设计文档

## 1. 系统概述
管理传送带上TOTAL_CARRIAGES个托架(索引0-(TOTAL_CARRIAGES-1))，跟踪芦笋直径信息，协调直径扫描仪、编码器和分支器控制器等模块执行分配动作。传送带向右侧移动，托架依次经过第一至第五个出口区域。

> **重要说明**：相位范围是0-199，代表物理上一圈的位置。物理上编码器旋转180度（半圈）时，有一个托架被插入到传送带；旋转一圈时，有两个托架被插入，均匀分布。编码器旋转物理的两圈（相对四圈）才会遇到一个出口，出口按距离均匀分布。所有出口分支器在第85相位位置触发动作。出口位置的索引值与托架的索引值一一对应，当出口位置索引与托架索引相同时，并且编码器处于第85相位时，系统会检查该托架是否应该通过分支器分离开，从传输线上分离出去。

> **注意**：TOTAL_CARRIAGES为系统配置常量，表示传送带上的托架总数，可根据实际硬件配置进行调整(如20、31、50等)。

## 2. 核心数据结构

### 2.1 托架(Carriage)数据结构
- **索引值(index)**：唯一标识，范围0-(TOTAL_CARRIAGES-1)
- **直径值(diameter)**：存储芦笋直径值(mm)，无效直径值设置为0或负数

### 2.2 出口(Diverter)数据结构
- **编号(id)**：出口编号，范围1-5
- **最小直径(minDiameter)**：该出口接受的最小直径值(mm)
- **最大直径(maxDiameter)**：该出口接受的最大直径值(mm)
- **分支器索引(diverterIndex)**：对应的分支器索引
- **分支点位置(divergencePointIndex)**：在传送带上的分支动作位置

> 注：分支器是固定安装的出口结构，不随传输带移动。传送带本身是静态物理结构，代码中采用数据移动模型而非位置追踪模型，新数据总是插入到索引0位置，然后随传送带物理移动而逻辑"移动"到更高索引位置

### 2.3 系统数据结构
- **直径数据数组(diameterArray)**：简单的float类型数组，存储TOTAL_CARRIAGES个直径值
- **分支点位置数组(divergencePointIndices)**：存储5个分支点位置的数组
- **当前计数位置(currentPosition)**：逻辑计数位置，用于跟踪系统状态

## 3. 系统工作流程

### 3.1 数据插入与移动同步
1. 直径扫描仪获取数据并插入到索引0位置
2. 通过编码器同步传送带移动，系统将所有数据逻辑地向后移动
3. 当传送带移动时，新数据被插入到索引0，已有数据依次向后移动，最后一个数据被丢弃

> 注：系统采用数据移动模型而非位置追踪模型，这更符合传送带的实际工作原理，即传送带是静态的，而物料在其上移动

### 3.1.1 数据移动机制详解
数据移动而非物理位置移动是系统的核心概念。具体实现如下：

- **数据插入时机**：当扫描仪完成扫描并获得芦笋直径数据后，立即触发数据插入操作
- **数据插入位置**：新获得的直径数据被插入到数据队列的第0号位置
- **数据右移**：插入新数据后，队列中所有原有数据依次向右移动一个位置
- **移动单位**：数据移动的单位是"位置"，对应编码器计数的增量变化
- **无条件插入**：数据插入操作是无条件的，只要扫描仪获得有效数据就会执行

这种机制使得数据在队列中的位置与物理传送带的位置保持同步，确保系统能够正确跟踪和处理每个芦笋。

### 3.2 直径分类规则

| 出口编号 | 直径范围 | 分配条件 |
|---------|---------|----------|
| 1       | 大直径   | 直径 > 15mm |
| 2       | 中-大直径 | 12mm < 直径 ≤ 15mm |
| 3       | 中直径   | 9mm < 直径 ≤ 12mm |
| 4       | 小-中直径 | 6mm < 直径 ≤ 9mm |
| 5       | 小直径   | 直径 ≤ 6mm |

### 3.3 分支器动作机制
1. 编码器在相位达到85时，通过回调机制触发系统的出口判断逻辑
2. 系统检查当前所有出口的位置索引
3. 对于每个出口，当出口位置索引与某个直径数据的索引相同时，系统检查该直径是否满足出口要求
4. 如果直径值有效且满足出口标准，则触发对应分支器动作，使芦笋从传输线上分离到输出仓
5. 如果直径值不满足出口要求，则芦笋继续随传输线向右移动
6. 当传输线编码器位置达到特定相位时，通过回调函数将分支器自动复位到标准位置
7. 由于出口按顺序排列，每个芦笋只会在第一个符合其直径标准的出口被分流

### 3.4 编码器相位85回调逻辑详解
编码器在相位达到85时的回调是系统中最关键的同步点：

- **触发时机**：当编码器的逻辑位置（相位）达到85时，编码器触发位置回调函数
- **回调功能**：该回调函数负责协调系统检查所有出口位置的分配条件
- **出口判断**：
  1. 遍历所有出口（1-5号）的位置索引
  2. 对于每个出口，查找与其位置索引对应的直径数据
  3. 检查该直径数据是否满足当前出口的直径范围要求
- **动作执行**：如果直径数据满足出口要求，系统立即触发对应的分支器动作
- **后续处理**：动作执行后，系统继续监控下一个相位85的到来

这种机制确保了所有出口的动作都在精确的物理位置上执行，实现了芦笋的准确分拣。

## 4. 模块协作关系

- **编码器**：提供相位信息，在第85相位触发位置回调事件，作为所有出口分支器动作的同步点
- **直径扫描仪**：在检测点获取直径数据，通过`addNewDiameterData()`将数据添加到索引0的托架
- **分支器控制器**：当编码器到达第85相位且出口位置索引与托架索引匹配时，根据分类规则执行分配动作
- **诊断控制器**：在不同工作模式下协调系统行为
- **出口对象**：作为独立实体，存储直径标准和位置索引信息，当位置索引与托架索引匹配时进行分配决策

## 5. 异常处理

- 无效直径值(0或负数)引导至出口5
- 检测到位置同步异常时重新初始化位置
- 编码器反向旋转触发报警状态