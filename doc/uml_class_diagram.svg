<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1000" width="1600" height="1000">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0L0,6L9,3z" fill="#ffffff" />
    </marker>
  </defs>
  
  <rect width="1600" height="1000" fill="#1a1a2e" />
  
  <text x="800" y="40" font-family="Arial" font-size="28" text-anchor="middle" font-weight="bold" fill="#f72585">ESP32 Sorter 系统类图（重构后）</text>

  <!-- Encoder类 - 左上 -->
  <rect x="50" y="80" width="320" height="260" fill="#2d6a4f" stroke="#48bb78" stroke-width="2" rx="8" />
  <text x="210" y="110" font-family="Arial" font-size="20" text-anchor="middle" font-weight="bold" fill="#ffffff">Encoder</text>
  <text x="210" y="130" font-family="Arial" font-size="12" text-anchor="middle" fill="#48bb78">单例模式</text>
  <line x1="50" y1="145" x2="370" y2="145" stroke="#48bb78" stroke-width="2" />
  <text x="65" y="170" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- count: long</text>
  <text x="65" y="190" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- lastCount: long</text>
  <text x="65" y="210" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- positionChanged: volatile bool</text>
  <text x="65" y="230" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- phaseCallback: PhaseCallback</text>
  <text x="65" y="250" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- phaseCallbackContext: void*</text>
  <line x1="50" y1="270" x2="370" y2="270" stroke="#48bb78" stroke-width="1" />
  <text x="65" y="295" font-family="Arial" font-size="11" fill="#ffffff">+ instance: Encoder*</text>
  <text x="65" y="315" font-family="Arial" font-size="11" fill="#ffffff">+ getInstance(): Encoder*</text>
  <text x="65" y="335" font-family="Arial" font-size="11" fill="#ffffff">+ initialize(): void</text>
  <text x="65" y="355" font-family="Arial" font-size="11" fill="#ffffff">+ setPhaseCallback(...): void</text>
  <text x="65" y="375" font-family="Arial" font-size="11" fill="#ffffff">+ getCurrentPosition(): int</text>
  <text x="65" y="395" font-family="Arial" font-size="11" fill="#ffffff">+ hasPositionChanged(): bool</text>
  <text x="65" y="415" font-family="Arial" font-size="11" fill="#ffffff">+ resetPositionChanged(): void</text>
  <text x="65" y="435" font-family="Arial" font-size="11" fill="#ffffff">+ handleAPhaseInterrupt(): void</text>
  <text x="65" y="455" font-family="Arial" font-size="11" fill="#ffffff">+ handleBPhaseInterrupt(): void</text>
  <text x="65" y="475" font-family="Arial" font-size="11" fill="#ffffff">+ handleZPhaseInterrupt(): void</text>
  <text x="65" y="495" font-family="Arial" font-size="11" fill="#ffffff">+ printout(): void</text>

  <!-- DiameterScanner类 - 右上 -->
  <rect x="1200" y="80" width="350" height="300" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="8" />
  <text x="1375" y="110" font-family="Arial" font-size="20" text-anchor="middle" font-weight="bold" fill="#ffffff">DiameterScanner</text>
  <line x1="1200" y1="145" x2="1550" y2="145" stroke="#c0392b" stroke-width="2" />
  <text x="1215" y="170" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- scannerPins[4]: int</text>
  <text x="1215" y="190" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- isScanning: bool</text>
  <text x="1215" y="210" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- highLevelCounts[4]: int</text>
  <text x="1215" y="230" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- objectCount: int</text>
  <text x="1215" y="250" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- lastSensorStates[4]: bool</text>
  <text x="1215" y="270" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- isSampling[4]: bool</text>
  <text x="1215" y="290" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- calculatedDiameter: int</text>
  <text x="1215" y="310" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- logLevel: LoggerLevel</text>
  <line x1="1200" y1="330" x2="1550" y2="330" stroke="#c0392b" stroke-width="1" />
  <text x="1215" y="355" font-family="Arial" font-size="11" fill="#ffffff">+ DiameterScanner()</text>
  <text x="1215" y="375" font-family="Arial" font-size="11" fill="#ffffff">+ initialize(): void</text>
  <text x="1215" y="395" font-family="Arial" font-size="11" fill="#ffffff">+ start(): void</text>
  <text x="1215" y="415" font-family="Arial" font-size="11" fill="#ffffff">+ sample(int): void</text>
  <text x="1215" y="435" font-family="Arial" font-size="11" fill="#ffffff">+ getDiameterAndStop(): int</text>
  <text x="1215" y="455" font-family="Arial" font-size="11" fill="#ffffff">+ getObjectCount(): int</text>
  <text x="1215" y="475" font-family="Arial" font-size="11" fill="#ffffff">+ setLogLevel(LoggerLevel): void</text>
  <text x="1215" y="495" font-family="Arial" font-size="11" fill="#ffffff">+ getLogLevel(): LoggerLevel</text>
  <text x="1215" y="515" font-family="Arial" font-size="11" fill="#ffffff">+ displayIOStatus(): void</text>
  <text x="1215" y="535" font-family="Arial" font-size="11" fill="#ffffff">+ displayRawDiameters(): void</text>

  <!-- TraySystem类 - 左下 -->
  <rect x="50" y="550" width="320" height="240" fill="#06d6a0" stroke="#0891b2" stroke-width="2" rx="8" />
  <text x="210" y="580" font-family="Arial" font-size="20" text-anchor="middle" font-weight="bold" fill="#ffffff">TraySystem</text>
  <line x1="50" y1="605" x2="370" y2="605" stroke="#0891b2" stroke-width="2" />
  <text x="65" y="630" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- TOTAL_TRAYS: const uint8_t</text>
  <text x="65" y="650" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- INVALID_DIAMETER: const int</text>
  <text x="65" y="670" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- trayDiameters[31]: int</text>
  <text x="65" y="690" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- trayScanCount[31]: int</text>
  <line x1="50" y1="710" x2="370" y2="710" stroke="#0891b2" stroke-width="1" />
  <text x="65" y="735" font-family="Arial" font-size="11" fill="#ffffff">+ TraySystem()</text>
  <text x="65" y="755" font-family="Arial" font-size="11" fill="#ffffff">+ addNewDiameterData(...): void</text>
  <text x="65" y="775" font-family="Arial" font-size="11" fill="#ffffff">+ moveTraysData(): void</text>
  <text x="65" y="795" font-family="Arial" font-size="11" fill="#ffffff">+ resetAllTraysData(): void</text>
  <text x="65" y="815" font-family="Arial" font-size="11" fill="#ffffff">+ getTrayDiameter(int): int</text>
  <text x="65" y="835" font-family="Arial" font-size="11" fill="#ffffff">+ getTrayScanCount(int): int</text>
  <text x="65" y="855" font-family="Arial" font-size="11" fill="#ffffff">+ getTotalTrays(): uint8_t</text>

  <!-- Outlet类 - 右下 -->
  <rect x="1250" y="550" width="300" height="200" fill="#f4a261" stroke="#e76f51" stroke-width="2" rx="8" />
  <text x="1400" y="580" font-family="Arial" font-size="20" text-anchor="middle" font-weight="bold" fill="#ffffff">Outlet</text>
  <text x="1400" y="600" font-family="Arial" font-size="12" text-anchor="middle" fill="#e76f51">8个实例</text>
  <line x1="1250" y1="615" x2="1550" y2="615" stroke="#e76f51" stroke-width="2" />
  <text x="1265" y="640" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- servo: Servo</text>
  <text x="1265" y="660" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- pin: int</text>
  <text x="1265" y="680" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- initialized: bool</text>
  <text x="1265" y="700" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- preOpenState: bool</text>
  <text x="1265" y="720" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- minDiameter: int</text>
  <text x="1265" y="740" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- maxDiameter: int</text>
  <line x1="1250" y1="760" x2="1550" y2="760" stroke="#e76f51" stroke-width="1" />
  <text x="1265" y="785" font-family="Arial" font-size="11" fill="#ffffff">+ Outlet()</text>
  <text x="1265" y="805" font-family="Arial" font-size="11" fill="#ffffff">+ initialize(...): void</text>
  <text x="1265" y="825" font-family="Arial" font-size="11" fill="#ffffff">+ getMinDiameter(): int</text>
  <text x="1265" y="845" font-family="Arial" font-size="11" fill="#ffffff">+ getMaxDiameter(): int</text>
  <text x="1265" y="865" font-family="Arial" font-size="11" fill="#ffffff">+ preOpen(bool): void</text>
  <text x="1265" y="885" font-family="Arial" font-size="11" fill="#ffffff">+ execute(): void</text>

  <!-- Sorter类 - 核心控制器 -->
  <rect x="450" y="300" width="400" height="320" fill="#2d3748" stroke="#4cc9f0" stroke-width="3" rx="8" />
  <text x="650" y="330" font-family="Arial" font-size="22" text-anchor="middle" font-weight="bold" fill="#ffffff">Sorter</text>
  <text x="650" y="350" font-family="Arial" font-size="12" text-anchor="middle" fill="#4cc9f0">核心控制器</text>
  <line x1="450" y1="365" x2="850" y2="365" stroke="#4cc9f0" stroke-width="2" />
  <text x="465" y="390" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- encoder: Encoder*</text>
  <text x="465" y="410" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- traySystem: TraySystem</text>
  <text x="465" y="430" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- scanner: DiameterScanner</text>
  <text x="465" y="450" font-family="Arial" font-size="11" font-style="italic" fill="#ffffff">- outlets[8]: Outlet</text>
  <line x1="450" y1="470" x2="850" y2="470" stroke="#4cc9f0" stroke-width="1" />
  <text x="465" y="495" font-family="Arial" font-size="11" fill="#ffffff">+ initialize(): void</text>
  <text x="465" y="515" font-family="Arial" font-size="11" fill="#ffffff">+ spinOnce(): void</text>
  <text x="465" y="535" font-family="Arial" font-size="11" fill="#4cc9f0">+ getDisplayData(): DisplayData</text>
  <text x="465" y="555" font-family="Arial" font-size="11" fill="#ffffff">+ onPhaseChange(int): void</text>

  <!-- UserInterface类 - 左中 -->
  <rect x="880" y="350" width="220" height="200" fill="#9b5de5" stroke="#7b2cbf" stroke-width="2" rx="8" />
  <text x="990" y="380" font-family="Arial" font-size="18" text-anchor="middle" font-weight="bold" fill="#ffffff">UserInterface</text>
  <text x="990" y="400" font-family="Arial" font-size="11" text-anchor="middle" fill="#9b5de5">单例模式</text>
  <line x1="880" y1="415" x2="1100" y2="415" stroke="#7b2cbf" stroke-width="2" />
  <text x="895" y="440" font-family="Arial" font-size="10" font-style="italic" fill="#ffffff">- oled: OLED*</text>
  <text x="895" y="460" font-family="Arial" font-size="10" font-style="italic" fill="#ffffff">- hmi: SimpleHMI*</text>
  <line x1="880" y1="480" x2="1100" y2="480" stroke="#7b2cbf" stroke-width="1" />
  <text x="895" y="505" font-family="Arial" font-size="10" fill="#ffffff">+ initialize(): void</text>
  <text x="895" y="525" font-family="Arial" font-size="10" fill="#ffffff">+ updateDisplay(...): void</text>
  <text x="895" y="545" font-family="Arial" font-size="10" fill="#ffffff">+ isMasterButtonPressed(): bool</text>

  <!-- DisplayData结构体 - 右中，靠近UserInterface -->
  <rect x="1130" y="350" width="240" height="200" fill="#ffd166" stroke="#e9c46a" stroke-width="2" rx="8" />
  <text x="1250" y="380" font-family="Arial" font-size="18" text-anchor="middle" font-weight="bold" fill="#ffffff">DisplayData</text>
  <text x="1250" y="400" font-family="Arial" font-size="11" text-anchor="middle" fill="#ffd166">数据结构体</text>
  <line x1="1130" y1="415" x2="1370" y2="415" stroke="#e9c46a" stroke-width="2" />
  <text x="1145" y="440" font-family="Arial" font-size="10" fill="#ffffff">+ currentMode: SystemMode</text>
  <text x="1145" y="460" font-family="Arial" font-size="10" fill="#ffffff">+ encoderPosition: int</text>
  <text x="1145" y="480" font-family="Arial" font-size="10" fill="#ffffff">+ sortingSpeed: int</text>
  <text x="1145" y="500" font-family="Arial" font-size="10" fill="#ffffff">+ latestDiameter: int</text>
  <text x="1145" y="520" font-family="Arial" font-size="10" fill="#ffffff">+ identifiedCount: int</text>

  <!-- 关联关系 -->
  <path d="M450 320 Q300 320 370 170" stroke="#4cc9f0" stroke-width="2" fill="none" marker-end="url(#arrow)" />
  <text x="390" y="250" font-family="Arial" font-size="12" text-anchor="middle" fill="#ffffff">has-a</text>
  
  <path d="M850 320 Q1000 320 1200 170" stroke="#4cc9f0" stroke-width="2" fill="none" marker-end="url(#arrow)" />
  <text x="1020" y="250" font-family="Arial" font-size="12" text-anchor="middle" fill="#ffffff">has-a</text>
  
  <path d="M450 580 Q300 580 370 620" stroke="#4cc9f0" stroke-width="2" fill="none" marker-end="url(#arrow)" />
  <text x="390" y="605" font-family="Arial" font-size="12" text-anchor="middle" fill="#ffffff">has-a</text>
  
  <path d="M850 580 Q1000 580 1250 620" stroke="#4cc9f0" stroke-width="2" fill="none" marker-end="url(#arrow)" />
  <text x="1020" y="605" font-family="Arial" font-size="12" text-anchor="middle" fill="#ffffff">has-a (8)</text>
  
  <line x1="850" y1="385" x2="880" y2="385" stroke="#4cc9f0" stroke-width="2" marker-end="url(#arrow)" />
  <text x="865" y="380" font-family="Arial" font-size="12" text-anchor="middle" fill="#ffffff">has-a</text>
  
  <line x1="850" y1="425" x2="1130" y2="425" stroke="#ffd166" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow)" />
  <text x="990" y="415" font-family="Arial" font-size="12" text-anchor="middle" fill="#ffd166">returns</text>

  <!-- 图例 -->
  <rect x="50" y="820" width="300" height="130" fill="#16213e" stroke="#4cc9f0" stroke-width="1" rx="5" />
  <text x="200" y="850" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold" fill="#ffffff">图例</text>
  <text x="65" y="880" font-family="Arial" font-size="12" fill="#ffffff">+ 公共成员</text>
  <text x="65" y="905" font-family="Arial" font-size="12" font-style="italic" fill="#ffffff">- 私有成员</text>
  <line x1="65" y1="930" x2="125" y2="930" stroke="#4cc9f0" stroke-width="2" marker-end="url(#arrow)" />
  <text x="135" y="934" font-family="Arial" font-size="12" fill="#ffffff">关联关系 (has-a)</text>
  <line x1="65" y1="950" x2="125" y2="950" stroke="#ffd166" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow)" />
  <text x="135" y="954" font-family="Arial" font-size="12" fill="#ffffff">返回关系 (returns)</text>

  <!-- 系统说明 -->
  <rect x="400" y="820" width="1150" height="130" fill="#16213e" stroke="#4cc9f0" stroke-width="1" rx="5" />
  <text x="975" y="850" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold" fill="#ffffff">系统架构说明（重构后）</text>
  <text x="420" y="880" font-family="Arial" font-size="11" fill="#4cc9f0">• Sorter 是核心控制器，协调所有子系统</text>
  <text x="420" y="900" font-family="Arial" font-size="11" fill="#4cc9f0">• UserInterface 合并了 OLED 和 SimpleHMI，统一管理显示和输入</text>
  <text x="420" y="920" font-family="Arial" font-size="11" fill="#4cc9f0">• DisplayData 是纯数据结构，用于在 Sorter 和 UserInterface 之间传递数据</text>
  <text x="420" y="940" font-family="Arial" font-size="11" fill="#4cc9f0">• 所有类通过主循环协调，OLED 不再直接依赖 Encoder 和 Sorter</text>
</svg>