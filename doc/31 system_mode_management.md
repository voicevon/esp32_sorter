# 系统工作模式管理

## 1. 工作模式定义
- **MODE_NORMAL**：正常工作模式，执行完整分拣流程（扫描物体直径、计算分类、控制出口分拣和上料器控制），包含两个子模式
  - 子模式0：统计信息（显示分拣速度、已识别数量和托架数量）
  - 子模式1：最新直径（显示最新检测到的直径值，即名义直径）
- **MODE_DIAGNOSE_ENCODER**：编码器诊断模式，包含两个子模式
  - 子模式0：位置显示（显示编码器当前逻辑位置，只在位置变化时更新显示）
  - 子模式1：相位变化（显示编码器相位变化信息，只在相位变化时更新显示）
- **MODE_DIAGNOSE_SCANNER**：扫描仪诊断模式，实时显示传感器原始数据和物体计数
- **MODE_DIAGNOSE_OUTLET**：出口诊断模式，包含两个子模式
  - 子模式0：轮巡降落（常态打开，偶尔闭合）
  - 子模式1：轮巡上升（常态闭合，偶尔打开）
- **MODE_TEST_RELOADER**：上料器测试模式（Feeder Test Mode），上料器舵机每5秒钟开关一次，持续15秒钟后关闭并保持5秒钟
- **MODE_VERSION_INFO**：版本信息模式，显示机器型号、版本号、作者版权、年份和电话

## 2. 模式切换机制
- **切换触发**：通过SimpleHMI模块的主按钮实现模式循环切换
- **切换方式**：主按钮的单次短按（按下并释放）操作会将系统切换到下一个工作模式
- **循环逻辑**：当切换到最后一个模式（MODE_VERSION_INFO）后，再次短按将回到第一个模式（MODE_NORMAL）
- **状态指示**：系统通过串口输出当前模式名称，LED现在只用于显示出口状态，不再用于模式指示
- **实现方式**：在main.cpp中使用switch-case结构实现不同模式的功能逻辑，根据当前模式变量执行相应的处理代码
- **子模式变量**：使用全局变量跟踪不同模式的子状态
  - normalSubMode：正常模式的子模式（0: 统计信息, 1: 最新直径）
  - encoderSubMode：编码器诊断模式的子模式（0: 位置显示, 1: 相位变化）
  - outletSubMode：出口诊断模式的子模式（0: 轮巡降落, 1: 轮巡上升）

## 3. OLED显示更新原则

### 3.1 编码器诊断模式的显示更新

在MODE\_DIAGNOSE\_ENCODER模式下，OLED显示更新遵循以下原则：

**避免过度刷新**：
- OLED显示器的刷新速度较慢，不能在每次编码器变化时都刷新
- 编码器变化可能非常快（在中断中），而显示更新优先级较低
- 如果每次变化都刷新，会导致间歇性显示和阻塞

**解决方案**：
- 使用位置变化标志（positionChanged）来跟踪编码器位置是否变化
- 中断只设置标志，不直接调用OLED显示
- OLED更新在主循环中进行，检查位置变化标志
- 只在位置真正变化时才更新显示内容

**子模式说明**：
- **子模式0（位置显示）**：只在编码器位置变化时更新显示
- **子模式1（相位变化）**：只在编码器相位变化时更新显示

### 3.2 正常模式的显示更新

在MODE\_NORMAL模式下，OLED显示更新遵循以下原则：

**避免过度刷新**：
- OLED显示器的刷新速度较慢，不能在每次数据变化时都刷新
- 如果每次变化都刷新，会导致间歇性显示和阻塞

**解决方案**：
- OLED更新在主循环中进行，按固定间隔更新显示
- 只在数据真正变化时才更新显示内容

**子模式说明**：
- **子模式0（统计信息）**：显示分拣速度（根/秒、根/分钟、根/小时）、已识别数量和托架数量
- **子模式1（最新直径）**：显示最新检测到的直径值（名义直径）

### 3.3 出口诊断模式的显示更新

在MODE\_DIAGNOSE\_OUTLET模式下，OLED显示更新遵循以下原则：

**避免过度刷新**：
- OLED显示器的刷新速度较慢，不能在每次状态变化时都刷新
- 如果每次变化都刷新，会导致间歇性显示和阻塞

**解决方案**：
- OLED更新在主循环中进行，按固定间隔更新显示
- 只在状态真正变化时才更新显示内容

**子模式说明**：
- **子模式0（轮巡降落）**：常态打开，偶尔闭合，显示出口编号和打开的出口数字
- **子模式1（轮巡上升）**：常态闭合，偶尔打开，显示关闭的出口编号和打开的出口数字

## 4. OLED显示模式实现重构

为了提高代码的可读性和可维护性，OLED类的显示逻辑已被重构为使用模式专用方法：

### 4.1 实现方式
- **主方法**：`update(const DisplayData& data)`
- **核心逻辑**：使用switch-case结构根据当前模式调用相应的专用显示方法
- **模式专用方法**：
  - `displayNormalMode(const DisplayData& data)`：处理正常模式显示
  - `displayEncoderDiagnosticMode(const DisplayData& data)`：处理编码器诊断模式显示
  - `displayOutletDiagnosticMode(const DisplayData& data)`：处理出口诊断模式显示
  - `displayOtherModes(const DisplayData& data)`：处理其他模式显示

### 4.2 重构优势
1. **提高代码可读性**：不同模式的显示逻辑分离到独立方法中
2. **降低维护难度**：修改特定模式显示时只需关注对应的方法
3. **增强扩展性**：添加新模式时只需编写新的显示方法
4. **保持一致性**：所有模式的显示更新遵循统一的流程和间隔