# ESP32 芦笋分拣系统需求文档 (System Requirements)

本文档定义了“反重力”芦笋分拣系统的功能需求和非功能需求，作为开发和测试的基准。

## 1. 系统概述 (Overview)
本系统基于 ESP32 微控制器，旨在自动化测量芦笋直径并根据直径将其分级归类到不同的出口。系统利用旋转编码器进行位置跟踪，利用光纤传感器进行直径测量，并利用舵机控制出口开合。

## 2. 功能需求 (Functional Requirements)

### 2.1 核心分拣功能
-   **RF-01 直径测量**: 系统必须能够通过光纤传感器阵列（4组）精确测量通过芦笋的直径。
-   **RF-02 动态分级**: 系统必须支持至少 8 个分拣等级，每个等级对应的直径范围可配置。
-   **RF-03 精确分流**: 系统必须根据编码器位置，精确控制对应出口的舵机在芦笋到达时打开，并在通过后关闭。
-   **RF-04 托盘跟踪**: 系统必须能够同时跟踪传送带上多个托盘的状态（直径、位置），处理能力至少覆盖 19 个托盘位。

### 2.2 用户交互功能 (HMI)
-   **RF-05 实时数据显示**: 必须在 OLED 屏幕上实时显示当前生产速度（个/小时）、最新检测直径 (mm) 和已生产总数。
-   **RF-06 模式切换**: 支持通过按键切换以下模式：
    -   正常模式 (Normal)
    -   诊断模式 (Diagnostic): 分别测试编码器、扫描仪、出口舵机。
    -   配置模式 (Config): 调整直径范围和舵机角度。
    -   版本信息 (Version): 显示系统版本和累计启动次数。
-   **RF-07 参数配置**: 用户必须能够在不重新烧录代码的情况下，通过按键和屏幕菜单调整每个出口的直径上下限和舵机开合角度，并断电保存。

### 2.3 数据统计功能
-   **RF-08 启动计数 (Boot Count)**: [NEW] 系统必须记录累计上电启动次数，并在版本信息页面显示。
-   **RF-09 产量统计**: 系统应统计本次开机后的总分拣数量。

## 3. 非功能需求 (Non-Functional Requirements)

-   **NFR-01 实时性**: 编码器中断响应延迟不得影响位置跟踪精度（在最高转速下不丢步）。
-   **NFR-02 稳定性**: 系统应能连续运行 24 小时无死机。
-   **NFR-03 数据持久性**: 配置参数和启动计数必须存储在 EEPROM 中，掉电不丢失。
-   **NFR-04 可维护性**: 代码架构应遵循模块化设计，具备清晰的文档（类图、状态图）。

## 4. 用例概览 (Use Cases)

| ID | 用例名称 | 触发条件 | 预期结果 |
| :--- | :--- | :--- | :--- |
| UC-01 | **正常分拣** | 系统上电且处于正常模式 | 传送带运转，扫描仪读取数据，符合条件的出口自动打开。 |
| UC-02 | **调整参数** | 长按主按钮进入配置模式 | 用户通过按钮修改出口1的最小直径为 20mm，保存后立即生效。 |
| UC-03 | **硬件诊断** | 切换至出口诊断模式 | 用户按下从按钮，对应的出口舵机动作，屏幕显示当前状态。 |
| UC-04 | **查看寿命** | 切换至版本信息模式 | 屏幕显示 Firmware Version 和 **Boot Count** (累计启动次数)。 |
