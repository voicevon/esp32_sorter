## 1. 概述
本文档定义ESP32分拣系统中上料器（舵机）的打开时机控制策略，确保芦笋准确落至传输线托架。

## 2. 控制原理
### 2.1 工作机制
通过舵机控制上料器开关，在传输线带动托架移动到特定位置时释放芦笋。

### 2.2 影响因素
- 传输线运行速度
- 芦笋掉落时间
- 系统响应时间（舵机动作时间）

## 3. 数学模型
### 3.1 坐标系定义
- **原点定义**：编码器零相位位置
- **方向**：传输线运动方向为正方向
- **单位**：编码器计数

### 3.2 基本计算公式
```
触发位置 = 目标投放位置 - 传输线速度 × 总延迟时间
```

**参数定义**：
- 触发位置：发出舵机打开指令时的编码器计数
- 目标投放位置：芦笋需要落入的理想位置（编码器值）。当传输线静止时，托架位于上料器正下方时的编码器值即为目标投放位置
- 传输线速度：编码器测量的实时速度（单位：计数/秒）
- 总延迟时间：从发出指令到芦笋实际落在传输线上的总时间（单位：秒），包括舵机响应时间和芦笋掉落时间

## 4. 软件功能需求
### 4.1 参数配置与存储
- 支持配置总延迟时间
- 支持配置目标投放位置
- 提供目标投放位置校准功能：当传输线静止时，将托架移动至上料器下方，记录此时编码器值作为目标投放位置
- 使用Preferences库存储配置参数
- 保存速度-最佳触发位置对照表
- 实现参数的备份和恢复功能

### 4.2 实时计算功能
- 实时监测传输线速度变化
- 基于目标投放位置和总延迟时间动态计算最佳触发位置
- 根据当前传输线速度，优先使用速度-最佳触发位置对照表查找对应触发位置，无匹配项时使用计算公式

### 4.3 自适应调整
- 提供目标投放位置的手动微调接口
- 根据实际投放结果自动调整总延迟时间

### 4.4 编码器应用
- 利用编码器脉冲数计算实时位置
- 建立编码器计数与物理位置的映射关系
- 实现传输线速度的实时测量

### 4.5 调试功能
- 实时显示关键参数
- 提供手动微调界面
- 支持测试模式
- 支持传输线静止状态下的目标投放位置校准功能