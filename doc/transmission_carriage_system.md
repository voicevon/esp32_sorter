# 传输线待分配托架系统软件设计文档

## 1. 系统概述
传输线待分配托架系统是ESP32 Sorter项目中的核心软件组件，负责管理传输线上的多个托架（0-30号索引），跟踪每个托架上待分类的芦笋直径信息（通过单点扫描仪获取），并在托架到达各个分支器位置时控制相应的舵机执行分配动作。系统包含5个分支器和5个出口，每个分支器负责判断芦笋是否从对应的出口分配出去。

### 1.1 数据获取与插入机制
单点扫描仪获取到芦笋直径信息后，系统会将该信息插入到托架队列的索引0位置。

## 2. 术语定义

- **托架(Carriage)**：传输线上用于承载待检测和分类物品（芦笋）的物理单元
- **分支器(Diverter)**：根据检测结果，通过舵机控制将芦笋引导到对应收集区域的机械装置，系统共有5个分支器，每个对应一个出口
- **索引值(Index)**：托架在软件系统中的唯一标识，范围从0到30
- **检测点(Detection Point)**：激光距离传感器检测芦笋直径的位置
- **分支点(Divergence Point)**：分支器执行分配动作的位置
- **单点扫描仪(Single-point Scanner)**：用于测量芦笋直径的传感器设备，测量数据插入到托架队列的索引0位置

## 3. 数据结构设计

### 3.1 托架类(Carriage)设计

每个托架对象包含以下属性：

- **索引值(index)**：唯一标识，范围0-30
- **直径值(diameter)**：存储该托架上芦笋的直径值（单位：mm）
- **状态标志(isValid)**：标识该托架是否有效（是否有待分配物品）
- **分配标志(isAssigned)**：标识该托架是否已经执行过分配动作

### 3.2 托架管理器(CarriageManager)设计

托架管理器负责整体系统的协调，包含：

- **托架列表(carriages)**：存储所有31个托架对象的数组
- **当前位置(currentPosition)**：跟踪传输线当前移动到的索引位置
- **检测点位置(detectionPointIndex)**：检测点对应的索引位置
- **分支点位置数组(divergencePointIndices)**：存储5个分支器对应的索引位置数组

## 4. 工作流程

### 4.1 数据插入流程

当在检测点成功获取芦笋直径后，系统执行以下操作：

1. 获取当前检测点对应的索引位置
2. 更新该索引位置对应的托架对象
   - 设置直径值为检测到的芦笋直径
   - 将状态标志(isValid)设置为true
   - 将分配标志(isAssigned)设置为false
3. 所有后续索引位置的托架对象依次向后移动一位
   - 索引n的托架移动到索引n+1的位置
   - 索引30的托架对象被丢弃

### 4.2 分配执行流程

系统采用级联式分配方式，共有5个分支点（出口），按照传输方向依次排列。当托架依次通过这些分支点时，系统执行以下操作：

1. **第一个分支点**：检查当前分支点位置对应的托架对象
   - 如果该托架有效且未分配，且直径 > 15mm：
     - 控制第1号舵机执行分配动作，将芦笋从此出口引导出去
     - 将该托架的分配标志(isAssigned)设置为true
2. **第二个分支点**：检查当前分支点位置对应的托架对象
   - 如果该托架有效且未分配，且直径 > 12mm：
     - 控制第2号舵机执行分配动作，将芦笋从此出口引导出去
     - 将该托架的分配标志(isAssigned)设置为true
3. **第三个分支点**：检查当前分支点位置对应的托架对象
   - 如果该托架有效且未分配，且直径 > 9mm：
     - 控制第3号舵机执行分配动作，将芦笋从此出口引导出去
     - 将该托架的分配标志(isAssigned)设置为true
4. **第四个分支点**：检查当前分支点位置对应的托架对象
   - 如果该托架有效且未分配，且直径 > 6mm：
     - 控制第4号舵机执行分配动作，将芦笋从此出口引导出去
     - 将该托架的分配标志(isAssigned)设置为true
5. **第五个分支点**：检查当前分支点位置对应的托架对象
   - 如果该托架有效且未分配（直径 ≤ 6mm）：
     - 控制第5号舵机执行分配动作，将芦笋从此出口引导出去
     - 将该托架的分配标志(isAssigned)设置为true

这种级联式分配确保每个芦笋只会被分配到第一个满足其直径条件的出口。

### 4.3 位置同步机制

传输线的移动通过编码器进行同步：

1. 编码器每旋转一定角度，传输线移动一个单位距离
2. 系统根据编码器计数计算当前传输线的位置
3. 当传输线移动一个单位距离时，更新当前位置索引值
4. 位置索引采用环形结构，当索引达到31时，重新从0开始计数

## 5. 直径分类规则

系统采用级联式分类方法，将芦笋按照直径从小到大分配到5个出口：

| 出口编号 | 直径范围 | 分配条件 |
|---------|---------|----------|
| 1       | 大直径   | 直径 > 15mm |
| 2       | 中-大直径 | 12mm < 直径 ≤ 15mm |
| 3       | 中直径   | 9mm < 直径 ≤ 12mm |
| 4       | 小-中直径 | 6mm < 直径 ≤ 9mm |
| 5       | 小直径   | 直径 ≤ 6mm |

分配顺序为：首先检查是否应该从出口1出去，否则继续检查出口2，依此类推。

## 6. 舵机控制逻辑

系统使用5个舵机分别控制5个分支器：

- **舵机1**：控制第一个分支器，对应出口1
- **舵机2**：控制第二个分支器，对应出口2
- **舵机3**：控制第三个分支器，对应出口3
- **舵机4**：控制第四个分支器，对应出口4
- **舵机5**：控制第五个分支器，对应出口5

- 舵机角度设置：
  - 标准位置（默认/不分配状态）：90°
  - 分配位置（引导芦笋从出口出去）：0°或180°（根据机械设计确定）
- 舵机动作时间：在托架到达分支点前50ms执行动作，确保分支器有足够时间响应
- 完成分配后，舵机应在100ms内恢复到标准位置，准备下一次分配

## 7. 异常处理

### 7.1 无效数据处理

- 如果检测到的直径值异常（如负值或超过预期范围），系统将其标记为无效
- 无效数据的托架将被引导至默认出口（第5个出口）

### 7.2 同步异常处理

- 系统定期检查编码器同步状态
- 如果检测到位置同步异常，将重新初始化当前位置

## 8. 性能优化考虑

- 使用数组而非链表存储托架对象，提高访问速度
- 采用环形缓冲区设计，避免频繁的内存分配和释放
- 提前计算分支点位置，减少实时计算负担

## 8.1 分支点位置设置

- 5个分支点位置应根据传输线的物理布局进行设置
- 分支点位置应按传输顺序递增排列
- 检测点位置应设置在第一个分支点位置之前
- 各分支点之间的距离应足够大，确保舵机有充分时间完成动作并复位

## 9. 代码结构建议

### 9.1 类设计

- **Carriage**：表示单个托架的数据结构
- **CarriageManager**：管理所有托架的核心类
- **DiverterController**：负责5个分支器舵机控制的辅助类

### 9.2 核心方法

- `CarriageManager::updateDetectionData(float diameter)`：更新检测数据
- `CarriageManager::updatePosition()`：更新当前位置
- `CarriageManager::processDivergence(int diverterIndex)`：处理指定分支器的动作
- `DiverterController::setDiverterPosition(int diverterIndex, bool shouldDivert)`：设置指定分支器的位置
- `DiverterController::resetAllDiverters()`：重置所有分支器到默认位置

## 10. 测试与验证方法

- 使用模拟数据测试托架移动和数据插入逻辑
- 验证在满负荷情况下（所有托架都有数据）系统的稳定性
- 测试各种异常情况，确保系统能够正确处理
- 实际运行时监控分支器动作的准确性和响应时间