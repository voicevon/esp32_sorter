# ESP32 Sorter 软件架构手册

本文档概述了 ESP32 Sorter 的软件架构，包括类关系、控制流程和核心逻辑。

---

## 1. 系统概述

### 1.1 核心组件
-   **Sorter**：中央协调器。管理 TraySystem（托盘系统）、Outlets（出口）、Encoder（编码器）和 Feeder（上料器）。
-   **TraySystem**：管理托盘队列的数据结构（31个位置）。存储每个位置的直径数据和扫描次数。
-   **Outlet**：控制物理分流的舵机驱动。
-   **Encoder**：提供系统的心跳（位置跟踪 0-199）。
-   **DiameterScanner**：用于测量物体的传感器接口。
-   **Feeder**：控制物体上料的时序。
-   **SimpleHMI**：管理按钮和 LED。

### 1.2 控制流程
1.  **初始化**：设置所有组件。
2.  **中断处理**：编码器触发 `Sorter::onPhaseChange()`。此函数非常轻量，仅设置状态标志位。
3.  **主循环**：`main.cpp` 持续调用 `sorter.spinOnce()`。
4.  **SpinOnce 执行**：检查中断设置的标志并执行繁重的逻辑：
    -   重置扫描仪。
    -   处理扫描数据 -> 存入 TraySystem。
    -   预设出口（匹配逻辑）。
    -   执行出口动作。
    -   控制上料时序。

---

## 2. 核心控制逻辑 (Sorter 类)

**Sorter** 类是系统的大脑。

### 2.1 职责
-   **协调**：将编码器位置更新链接到具体动作（扫描、分拣、上料）。
-   **状态管理**：保存机器状态（运行模式、诊断模式）。
-   **时序**：基于编码器相位（而非仅基于时间）管理精确时序。

### 2.2 关键方法
-   `onPhaseChange(int phase)`：ISR 调用。设置标志位。
-   `spinOnce()`：主工作函数。
-   `presetOutlets()`：根据托盘数据确定哪些出口应打开。
-   `getSortingSpeed()`：计算吞吐量指标。

---

## 3. 子系统

### 3.1 托盘系统 (Tray System)
管理一个包含31个托盘位置的环形队列。
-   **数据**：存储每个托盘的 `diameter_mm`（直径毫米）和 `scan_count`（扫描次数）。
-   **移动**：`moveTraysData()` 将数据索引移动 1 位（模拟传送带移动）。
-   **逻辑**：直径为 0 表示空托盘。

### 3.2 上料器时序控制 (Feeder Timing Control)
控制上料器何时投放物品，确保物品准确落在托盘上。
-   **触发**：基于 "目标投放位置" - (速度 * 延迟)。
-   **校准**：支持静态校准（停止时投放）和动态调整。
-   **相位**：
    -   在相位 200 打开。
    -   在相位 220 关闭。

### 3.3 出口匹配规则 (Outlet Matching Rules)
定义直径如何映射到物理出口。

**逻辑流程**:
1.  **数据采集**：在相位 50，扫描仪数据 -> TraySystem。
2.  **决策**：`presetOutlets()` 根据规则检查 TraySystem 数据。
3.  **执行**：在相位 80，舵机动作。
4.  **复位**：在相位 195，出口关闭。

**分拣逻辑 (直径范围)**:
-   **出口 0**：特殊/多次扫描物品。
-   **出口 1**：> 13mm (大)。
-   **出口 2**：10-13mm (中)。
-   **出口 3**：8-10mm (中小)。
-   **出口 4**：6-8mm (小)。
-   **默认**：< 6mm 从末端流出。

*(注：直径为整数毫米值)*
