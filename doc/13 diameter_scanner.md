# DiameterScanner类

## 1. 概述
提供数据采样和直径计算功能，使用4点扫描仪测量物体直径。

## 2. 公共接口
- `DiameterScanner()`：构造函数，初始化成员变量
- `void initialize()`：初始化引脚和状态变量
- `void start()`：重置状态变量和计数
- `void sample(int phase)`：根据编码器相位采样传感器状态
- `int getDiameterAndStop()`：获取计算的直径值（单位为unit）
- `int getObjectCount()`：获取统计的物体数量

## 3. 核心功能
- 维护4个扫描点的采样状态和物体计数
- 跟踪每个传感器状态变化，统计物体通过情况
- 使用权重系数修正每个扫描点的测量值（补偿芦笋锥形形状）
- 过滤无效数据（小于3毫米的数据）
- 使用中位数算法计算物体直径值（单位为unit）

## 4. 工作原理
- 使用4个扫描点同时采集物体直径数据
- 每个扫描点独立记录高电平持续时间
- 每个扫描点的采样值乘以对应的权重系数进行修正
- 过滤掉小于3毫米（6个unit）的无效数据
- 根据有效数据数量使用不同的中位数算法：
  - 2个有效数据：取平均值
  - 3个有效数据：取中间值
  - 4个有效数据：去掉最大值和最小值，取中间两个值的平均值
- 使用编码器相位信息进行精确采样
- 输出直径值单位为"unit"，实际毫米数 = unit值 / 2（取整数）

## 5. 权重系数
由于芦笋接近锥形，不同位置的直径不同，需要使用权重系数进行补偿：
- 扫描点1权重：1.01
- 扫描点2权重：1.02
- 扫描点3权重：1.05
- 扫描点4权重：1.15

## 6. 数据过滤
- 最小有效直径：3毫米（6个unit）
- 小于最小有效直径的数据会被丢弃，不参与中位数计算

## 7. 引脚定义
- 扫描点1：GPIO 36
- 扫描点2：GPIO 35
- 扫描点3：GPIO 34
- 扫描点4：GPIO 39

## 8. 测试方法
### 8.1 诊断模式测试
- **模式名称**：MODE_DIAGNOSE_SCANNER
- **切换方式**：通过主按钮切换到此模式
- **测试功能**：实时显示传感器原始数据和物体计数
- **适用场景**：验证扫描仪硬件连接、信号采集和数据统计功能

### 8.2 子测试模式
在 MODE_DIAGNOSE_SCANNER 模式下，通过从按钮切换不同的子测试模式：

#### 8.2.1 子模式1：IO状态检查（默认）
- **功能**：检查4个扫描点的IO工作状态
- **实现方法**：`displayIOStatus()`
- **调用方式**：在main函数中，当处于MODE_DIAGNOSE_SCANNER模式的子模式1时调用此方法
- **输出方式**：
  - 每次调用时，输出所有4个扫描点的当前状态
  - 格式为：H L H L（4个值并排显示，用空格分隔）
  - 当任何一个传感器状态变化时，输出所有4个扫描点的当前状态
  - 通过串口输出状态信息
  - 通过SSD1306 OLED显示器显示状态

#### 8.2.2 子模式2：直径测试
- **功能**：显示4个扫描点测得的原始直径值
- **实现方法**：`displayRawDiameters()`
- **调用方式**：在main函数中，当处于MODE_DIAGNOSE_SCANNER模式的子模式2时调用此方法
- **输出方式**：
  - 显示4个扫描点的原始直径值
  - 通过串口输出直径数据
  - 通过SSD1306 OLED显示器显示直径

#### 8.2.3 子模式3：循环切换
- **功能**：从最后一个子模式回到第一个子模式
- **切换逻辑**：当达到最后一个子模式后，再次按下从按钮将回到子模式1（IO状态检查）

### 8.3 测试步骤
1. 确保系统正常启动
2. 通过主按钮切换到 MODE_DIAGNOSE_SCANNER 模式
3. 使用从按钮在3个子测试模式之间切换
4. 在子模式1下验证IO状态检查功能
5. 在子模式2下验证直径显示功能
6. 验证子模式3的循环切换功能

### 8.4 验证要点
- 验证4个扫描点是否都能正常工作
- 验证权重系数修正是否生效
- 验证数据过滤是否正确丢弃无效数据
- 验证中位数算法是否根据有效数据数量正确计算
- 验证物体计数是否准确
- 验证串口和OLED显示器输出是否正常